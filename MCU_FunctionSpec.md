
# 電腦修護第二站 — Arduino 介面卡端功能規格書  
## Functional Specification — MCU Side (ATmega328P / Arduino)

## 版本資訊
- 文件版本：v1.0  
- 適用競賽：114 學年度工業類科學生技藝競賽 第二站  
- 範圍：USB 介面卡（TFT + WS2812 + EEPROM + 按鍵 + UART）

---

# 1. 系統架構

## 1.1 主要硬體
- MCU：ATmega328P / Arduino Nano  
- 顯示模組：TFT LCD（SPI）  
- RGB LED：WS2812 8 顆  
- 按鍵：S1、S2、S3、S4  
- EEPROM：MCU 內建  
- 藍牙模組：HC-05 / HC-06（需設定名稱）  
- USB 通訊：CH340 / FT232  

---

# 2. MCU 功能需求總表

| 編號 | 功能分類 | 功能名稱 | 描述 |
|------|----------|-----------|--------|
| MCU-F1 | TFT | 初始畫面顯示 | 顯示時間、崗位號碼、LED 全滅 |
| MCU-F2 | 按鍵 | 單鍵 btn-X 顯示 | S1∼S4 按下 → 顯示 btn-X → 0.5 秒還原 |
| MCU-F3 | 按鍵 | 雙鍵 RGB 模式 | S1+S2 >0.5 秒 → 隨機 RGB → LED 同步顯示 |
| MCU-F4 | BLE | 名稱設定 | `BT-XX` |
| MCU-F5 | TFT | 顯示模式切換 | 日期時間 / 時間模式 |
| MCU-F6 | UART | 與 PC 連線狀態顯示 | 右上角符號變化 |
| MCU-F7 | UART | 接收時間同步 | PC 傳時間 → MCU 更新 TFT |
| MCU-F8 | System | 顯示 CPU/RAM | 顯示模式 C3 時顯示系統資訊 |
| MCU-F9 | EEPROM | LED 腳位讀寫 | 儲存 LED 控制值 |
| MCU-F10 | EEPROM | 斷電保存 | 模式與 LED 值不可丟失 |
| MCU-F11 | LED | 依二進位顯示 LED | EEPROM 230 → LED 依 bit 控制 |
| MCU-F12 | 流程 | 放開按鍵自動復原 | RGB 模式結束後還原顯示 |

---

# 3. TFT 顯示規格

## 3.1 初始顯示
```
12:00:00   C1
    84
```
- 左上角：時間（初始 fake 時鐘或等待 PC sync）  
- 右上角：模式代碼（C1）  
- 中間：崗位號碼（XX）  

---

## 3.2 顯示模式（模式切換）
| 模式代號 | 顯示內容 |
|----------|-----------|
| C1 | 日期 + 時間 |
| C2 | 時間（HH:mm:ss） |
| C3 | CPU / RAM 顯示 |
| 5 | EEPROM Locked 狀態 |

---

# 4. 按鍵功能

## 4.1 單鍵（MCU-F2）
按 S1〜S4：

- 顯示 `btn-1` 等文字  
- 停留 0.5 秒  
- 自動還原顯示  
- 不可使用 delay（避免系統阻塞）

---

## 4.2 雙鍵 RGB 模式（MCU-F3）
S1 + S2 超過 0.5 秒：

- 產生 RGB 隨機值  
- 更新 TFT：  
  ```
  R:255
  G:123
  B:033
  ```  
- 所有 WS2812 LED 設同一顏色  
- 每秒更新一次  
- 放開任意按鍵 → 自動恢復  

---

## 4.3 EEPROM 已設定時的進階模式（MCU-F11）
若 EEPROM LED 值 ≠ 255：

- RGB 顏色仍為隨機  
- LED 亮滅依二進位表示  

例如 EEPROM = 230：

```
230 = 1110 0110
```

LED8 ←→ LED1  
1 = 亮  
0 = 滅

---

# 5. 通訊行為（UART）

## 5.1 MCU 接收格式
| 指令 | 意義 |
|------|------|
| `T2024/10/23 13:20:30` | 時間同步 |
| `Scpu=58;ram=8.3/15.9` | CPU/RAM 資訊 |
| `R` | 回傳 EEPROM LED 值 |
| `L230` | 寫入 LED 值 230 |
| `M1/M2` | 切換顯示模式 |

---

## 5.2 MCU 回傳格式
| 回傳內容 | 情境 |
|----------|--------|
| `VAL=255` | EEPROM 未設定 |
| `VAL=230` | 實際 EEPROM 值 |
| `WRITE OK` | 寫入成功 |
| `OK` | 一般確認封包 |
| `ERR` | 格式錯誤 |

---

# 6. EEPROM 規格

| 地址 | 內容 |
|------|--------|
| 0x00 | 顯示模式（0=完整、1=時間） |
| 0x01 | LED 腳位值（1–254，255 表預設） |

開機流程：
1. 讀取 EEPROM 內容  
2. 設定顯示模式  
3. 等待 PC Open 連線  

---

# 7. 藍牙設定（MCU-F4）

需設定名稱：

```
AT+NAME=BT-XX
```

密碼可自訂：

```
AT+PSWD=1234
```

---

# 8. LED 控制規格（MCU-F11）

## 8.1 預設狀態
- 全部 LED 熄滅  

## 8.2 RGB 隨機模式
- 若 EEPROM 未設定 → 全亮  
- 若 EEPROM 已設定 → 依二進位 bit 決定亮滅  

---

# 9. 錯誤處理

需處理：
- 收到未知封包 → 回傳 `ERR`  
- EEPROM 非法值 → 忽略並回傳 `ERR`  
- UART 斷線 → TFT 顯示未連線符號  

---

# Arduino 介面卡端功能規格書 — 完
